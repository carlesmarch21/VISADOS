<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Unificada de Caducidades</title>
    <style>
        /* ------------------ ESTILOS GLOBALES ------------------ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f6f9;
            color: #495057;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            /* Para el layout con sidebar */
        }

        /* ------------------ SIDEBAR ------------------ */
        .sidebar {
            width: 250px;
            /* Increased width for more space */
            background-color: #343a40;
            color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            height: 100vh;
            /* Ocupa toda la altura de la ventana */
            overflow-y: auto;
            /* Para scroll si hay muchos elementos */
            flex-shrink: 0;
            /* Prevent sidebar from shrinking */
        }

        .sidebar h2 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: none;
            padding-bottom: 0;
        }

        .sidebar nav ul {
            list-style: none;
            padding: 0;
        }

        .sidebar nav ul li {
            margin-bottom: 10px;
        }

        .sidebar nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            border-radius: 8px;
            transition: background-color 0.2s ease-in-out;
            font-size: 0.95em;
        }

        .sidebar nav ul li a:hover,
        .sidebar nav ul li a.active {
            background-color: #007bff;
        }

        /* Sub-menu styling */
        .sidebar nav ul li .submenu {
            list-style: none;
            padding-left: 20px;
            margin-top: 5px;
            display: none;
            /* Hidden by default */
        }

        .sidebar nav ul li .submenu.active {
            display: block;
        }

        .sidebar nav ul li .submenu li a {
            padding: 8px 15px;
            font-size: 0.9em;
            background-color: #495057;
            /* Slightly different background for sub-items */
        }

        .sidebar nav ul li .submenu li a:hover,
        .sidebar nav ul li .submenu li a.active {
            background-color: #0056b3;
            /* Darker blue for active sub-item */
        }


        /* ------------------ CONTENIDO PRINCIPAL ------------------ */
        .main-content {
            flex-grow: 1;
            /* Ocupa el espacio restante */
            padding: 20px;
            max-width: calc(100% - 250px);
            /* Adjust based on sidebar width */
            box-sizing: border-box;
            overflow-y: auto;
            /* Enable scrolling for main content */
            height: 100vh;
            /* Ensure it takes full viewport height */
        }

        h2 {
            margin-top: 30px;
            color: #343a40;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }

        hr {
            border: none;
            border-top: 1px solid #dee2e6;
            margin: 20px 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #6c757d;
            font-weight: 500;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 15px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        button {
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.15s ease-in-out;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:active {
            background-color: #004085;
            transform: translateY(1px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 600;
            cursor: pointer;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .actions button {
            background: none;
            color: #007bff;
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 18px;
            opacity: 0.8;
            transition: color 0.15s ease-in-out, opacity 0.15s ease-in-out;
        }

        .actions button:hover {
            color: #dc3545;
            opacity: 1;
        }

        /* Inline editing styles */
        .inline-edit-input {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* -------- CONTROLES COMPARTIDOS (Plantilla / Avisos) -------- */
        .controls-row {
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .controls-row>div {
            flex: 1 1 160px;
        }

        /* ---------- BOTONES DE TAG ---------- */
        #tagContainer {
            margin-bottom: 20px;
        }

        .tag-btn {
            padding: 8px 12px;
            background-color: #ffffff;
            border: 1px solid #ced4da;
            border-radius: 6px;
            margin-right: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            color: #495057;
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, color 0.15s ease-in-out;
        }

        .tag-btn:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        /* Filtro bar */
        .filter-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar input,
        .filter-bar select,
        .filter-bar button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ced4da;
        }

        .filter-bar button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }

        .filter-bar button:hover {
            background-color: #0056b3;
        }

        /* Toast */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: #343a40;
            color: #fff;
            padding: 10px 14px;
            border-radius: 6px;
            margin-top: 10px;
            opacity: 0.9;
            animation: fadein 0.5s, fadeout 0.5s 2s;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 20px;
                opacity: 0.9;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 20px;
                opacity: 0;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Above toast */
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .modal-content p {
            font-size: 1.1em;
            margin-bottom: 25px;
            color: #343a40;
        }

        .modal-actions button {
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }

        #confirmYesBtn {
            background-color: #28a745; /* Green for Yes */
            color: white;
            border: none;
        }

        #confirmYesBtn:hover {
            background-color: #218838;
        }

        #confirmNoBtn {
            background-color: #dc3545; /* Red for No */
            color: white;
            border: none;
        }

        #confirmNoBtn:hover {
            background-color: #c82333;
        }


        /* Pagination controls */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .pagination-controls button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.15s ease-in-out;
        }

        .pagination-controls button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .pageInfo {
            font-weight: bold;
            color: #343a40;
        }

        /* ---------- DASHBOARD STYLES ---------- */
        .dashboard-section-container {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-card {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            padding: 25px;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .dashboard-card h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .dashboard-card p {
            font-size: 2.5em;
            font-weight: bold;
            color: #343a40;
            margin: 0;
            cursor: pointer;
            /* Makes it look clickable */
        }

        .dashboard-card p:hover {
            text-decoration: underline;
        }


        .dashboard-settings {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-top: 30px;
        }

        .dashboard-settings h3 {
            margin-top: 0;
            color: #343a40;
        }

        .dashboard-settings .controls-row {
            align-items: center;
        }

        .dashboard-expiring-list {
            margin-top: 30px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .dashboard-expiring-list ul {
            list-style: none;
            padding: 0;
        }

        .dashboard-expiring-list li {
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            /* Para que los botones bajen en pantallas pequeñas */
        }

        .dashboard-expiring-list li:last-child {
            border-bottom: none;
        }

        .dashboard-expiring-list .expiring-info {
            font-weight: 500;
            flex-grow: 1;
            /* Ocupa el espacio disponible */
        }

        .dashboard-expiring-list .expiring-date {
            color: #dc3545;
            font-weight: bold;
            margin-right: 15px;
            /* Espacio antes de los botones */
        }

        .dashboard-expiring-list .actions-inline {
            display: flex;
            gap: 8px;
            margin-top: 5px;
            /* Pequeño margen superior para los botones en dispositivos móviles */
        }

        .dashboard-expiring-list .actions-inline button {
            padding: 6px 10px;
            font-size: 14px;
            border-radius: 6px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }

        .dashboard-expiring-list .actions-inline button:hover {
            background-color: #0056b3;
        }


        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <h2>Gestión de Caducidades</h2>
        <nav>
            <ul>
                <li><a href="#" id="nav-dashboard" class="active">Dashboard</a></li>
                <li>
                    <a href="#" id="nav-tacografo">Tarjetas de Tacógrafo</a>
                    <ul class="submenu" id="submenu-tacografo">
                        <li><a href="#" id="nav-new-tacografo">Nueva Tarjeta</a></li>
                        <li><a href="#" id="nav-listado-tacografo">Listado</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#" id="nav-licencia">Licencias Comunitarias</a>
                    <ul class="submenu" id="submenu-licencia">
                        <li><a href="#" id="nav-new-licencia">Nueva Licencia</a></li>
                        <li><a href="#" id="nav-listado-licencia">Listado</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#" id="nav-visados">Gestión de Visados</a>
                    <ul class="submenu" id="submenu-visados">
                        <li><a href="#" id="nav-new-visado">Nueva Renovación</a></li>
                        <li><a href="#" id="nav-listado-visado">Listado de Renovaciones</a></li>
                    </ul>
                </li>
                <li><a href="#" id="nav-plantillas">Plantillas de Avisos</a></li>
            </ul>
        </nav>
    </aside>

    <div class="main-content">
        <section id="dashboard-section">
            <h2>Dashboard de Caducidades</h2>

            <div class="dashboard-settings">
                <h3>Configuración de Avisos</h3>
                <div class="controls-row">
                    <div>
                        <label for="daysBeforeDashboard">Mostrar avisos con</label>
                        <select id="daysBeforeDashboard">
                            <option value="30">30 días de antelación</option>
                            <option value="60">60 días de antelación</option>
                            <option value="90">90 días de antelación</option>
                            <option value="0">Todas las próximas</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="dashboard-section-container">
                <h3>Tarjetas de Tacógrafo Digital</h3>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>Total Caducan en <span id="dashboard-days-setting-tacografo">30</span> días</h3>
                        <p id="totalExpiringTacografo" data-card-type="tacografo" data-filter-category=""
                            data-filter-days="dynamic"></p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Conductores</h3>
                        <p id="expiringConductoresTacografo" data-card-type="tacografo" data-filter-category="CONDUCTOR"
                            data-filter-days="dynamic"></p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Empresas</h3>
                        <p id="expiringEmpresasTacografo" data-card-type="tacografo" data-filter-category="EMPRESA"
                            data-filter-days="dynamic"></p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Centros de Ensayo</h3>
                        <p id="expiringCentrosTacografo" data-card-type="tacografo"
                            data-filter-category="CENTRO DE ENSAYO" data-filter-days="dynamic"></p>
                    </div>
                </div>
                <div class="dashboard-expiring-list">
                    <h3>Detalle de Caducidades Próximas (Tacógrafo)</h3>
                    <ul id="expiringCardsListTacografo">
                    </ul>
                </div>
            </div>

            <div class="dashboard-section-container">
                <h3>Licencias Comunitarias</h3>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>Total Caducan en <span id="dashboard-days-setting-licencia">30</span> días</h3>
                        <p id="totalExpiringLicencia" data-card-type="licencia" data-filter-category=""
                            data-filter-days="dynamic"></p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Licencias</h3>
                        <p id="expiringLicencias" data-card-type="licencia" data-filter-category="LICENCIA COMUNITARIA"
                            data-filter-days="dynamic"></p>
                    </div>
                </div>
                <div class="dashboard-expiring-list">
                    <h3>Detalle de Caducidades Próximas (Licencias Comunitarias)</h3>
                    <ul id="expiringCardsListLicencia">
                    </ul>
                </div>
            </div>

            <div class="dashboard-section-container">
                <h3>Renovaciones de Visados</h3>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>Total Caducan en <span id="dashboard-days-setting-visado">30</span> días</h3>
                        <p id="totalExpiringVisado" data-card-type="visado" data-filter-category=""
                            data-filter-days="dynamic"></p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Visados MDP</h3>
                        <p id="expiringMDPVisado" data-card-type="visado" data-filter-category="MDP"
                            data-filter-days="dynamic"></p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Visados MDL</h3>
                        <p id="expiringMDLVisado" data-card-type="visado" data-filter-category="MDL"
                            data-filter-days="dynamic"></p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Visados OT</h3>
                        <p id="expiringOTVisado" data-card-type="visado" data-filter-category="OT"
                            data-filter-days="dynamic"></p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Visados MPC</h3>
                        <p id="expiringMPCVisado" data-card-type="visado" data-filter-category="MPC"
                            data-filter-days="dynamic"></p>
                    </div>
                </div>
                <div class="dashboard-expiring-list">
                    <h3>Detalle de Caducidades Próximas (Visados)</h3>
                    <ul id="expiringCardsListVisado">
                    </ul>
                </div>
            </div>

        </section>

        <section id="new-tacografo-section" class="hidden">
            <h2>Nueva Tarjeta de Tacógrafo</h2>
            <form id="formTacografo">
                <label for="nombreTacografo">Nombre</label>
                <input type="text" id="nombreTacografo" name="nombre" required>

                <label for="dniTacografo">DNI</label>
                <input type="text" id="dniTacografo" name="dni" required>

                <label for="fechaCaducidadTacografo">Fecha de Caducidad</label>
                <input type="date" id="fechaCaducidadTacografo" name="fechaCaducidad" required>

                <label for="categoriaTacografo">Categoría</label>
                <select id="categoriaTacografo" name="categoria">
                    <option value="">-- Seleccionar --</option>
                    <option value="CONDUCTOR">CONDUCTOR</option>
                    <option value="EMPRESA">EMPRESA</option>
                    <option value="CENTRO DE ENSAYO">CENTRO DE ENSAYO</option>
                </select>

                <label for="mediadorTacografo">Mediador</label>
                <input type="text" id="mediadorTacografo" name="mediador">

                <label for="telefonoTacografo">Teléfono</label>
                <input type="text" id="telefonoTacografo" name="telefono">

                <label for="emailTacografo">Correo Electrónico</label>
                <input type="email" id="emailTacografo" name="email">

                <button type="submit">Guardar Tarjeta</button>
            </form>
        </section>

        <section id="listado-tacografo-section" class="hidden">
            <h2>Listado de Tarjetas de Tacógrafo</h2>
            <div class="filter-bar">
                <input type="text" id="buscarTacografo" placeholder="Buscar...">
                <select id="fCategoriaTacografo">
                    <option value="">Categoría (Todas)</option>
                    <option value="CONDUCTOR">CONDUCTOR</option>
                    <option value="EMPRESA">EMPRESA</option>
                    <option value="CENTRO DE ENSAYO">CENTRO DE ENSAYO</option>
                </select>
                <label for="pageSizeTacografo">Mostrar</label>
                <select id="pageSizeTacografo">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="0">Todos</option>
                </select>
                <button id="importBtnTacografo">Importar CSV</button>
                <button id="exportBtnTacografo">Exportar CSV</button>
                <input type="file" id="csvFileTacografo" accept=".csv" style="display: none;">
            </div>
            <table>
                <thead>
                    <tr>
                        <th data-key="nombre">Nombre</th>
                        <th data-key="dni">DNI</th>
                        <th data-key="fechaCaducidad">Fecha de Caducidad</th>
                        <th data-key="categoria">Categoría</th>
                        <th data-key="mediador">Mediador</th>
                        <th data-key="telefono">Teléfono</th>
                        <th data-key="email">Correo Electrónico</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tbodyTacografo"></tbody>
            </table>
            <div id="pagination-controls-tacografo" class="pagination-controls">
                <button id="prevPageBtnTacografo">Anterior</button>
                <span id="pageInfoTacografo" class="pageInfo">Página 1 de 1</span>
                <button id="nextPageBtnTacografo">Siguiente</button>
            </div>

            <h2>Avisos masivos para Tacógrafo</h2>
            <hr>
            <div class="controls-row">
                <div>
                    <label for="categoriaAvisoTacografo">Categoría</label>
                    <select id="categoriaAvisoTacografo">
                        <option value="">-- Todas --</option>
                        <option value="CONDUCTOR">CONDUCTOR</option>
                        <option value="EMPRESA">EMPRESA</option>
                        <option value="CENTRO DE ENSAYO">CENTRO DE ENSAYO</option>
                    </select>
                </div>
                <div>
                    <label for="canalAvisoTacografo">Canal</label>
                    <select id="canalAvisoTacografo">
                        <option value="email">Email</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="ambos">Ambos</option>
                    </select>
                </div>
                <div>
                    <label for="daysBeforeMassiveTacografo">Días de antelación</label>
                    <input type="number" id="daysBeforeMassiveTacografo" value="30" min="0">
                </div>
            </div>
            <button id="enviarAvisosTacografo">Enviar avisos</button>
        </section>


        <section id="new-licencia-section" class="hidden">
            <h2>Nueva Licencia Comunitaria</h2>
            <form id="formLicencia">
                <label for="nombreLicencia">Nombre</label>
                <input type="text" id="nombreLicencia" name="nombre" required>

                <label for="cifLicencia">CIF</label>
                <input type="text" id="cifLicencia" name="cif" required>

                <label for="fechaCaducidadLicencia">Fecha de Caducidad</label>
                <input type="date" id="fechaCaducidadLicencia" name="fechaCaducidad" required>

                <label for="telefonoLicencia">Teléfono</label>
                <input type="text" id="telefonoLicencia" name="telefono">

                <label for="emailLicencia">Correo Electrónico</label>
                <input type="email" id="emailLicencia" name="email">

                <button type="submit">Guardar Licencia</button>
            </form>
        </section>

        <section id="listado-licencia-section" class="hidden">
            <h2>Listado de Licencias Comunitarias</h2>
            <div class="filter-bar">
                <input type="text" id="buscarLicencia" placeholder="Buscar...">
                <label for="pageSizeLicencia">Mostrar</label>
                <select id="pageSizeLicencia">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="0">Todos</option>
                </select>
                <button id="importBtnLicencia">Importar CSV</button>
                <button id="exportBtnLicencia">Exportar CSV</button>
                <input type="file" id="csvFileLicencia" accept=".csv" style="display: none;">
            </div>
            <table>
                <thead>
                    <tr>
                        <th data-key="nombre">Nombre</th>
                        <th data-key="cif">CIF</th>
                        <th data-key="fechaCaducidad">Fecha de Caducidad</th>
                        <th data-key="telefono">Teléfono</th>
                        <th data-key="email">Correo Electrónico</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tbodyLicencia"></tbody>
            </table>
            <div id="pagination-controls-licencia" class="pagination-controls">
                <button id="prevPageBtnLicencia">Anterior</button>
                <span id="pageInfoLicencia" class="pageInfo">Página 1 de 1</span>
                <button id="nextPageBtnLicencia">Siguiente</button>
            </div>

            <h2>Avisos masivos para Licencias Comunitarias</h2>
            <hr>
            <div class="controls-row">
                <div>
                    <label for="canalAvisoLicencia">Canal</label>
                    <select id="canalAvisoLicencia">
                        <option value="email">Email</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="ambos">Ambos</option>
                    </select>
                </div>
                <div>
                    <label for="daysBeforeMassiveLicencia">Días de antelación</label>
                    <input type="number" id="daysBeforeMassiveLicencia" value="30" min="0">
                </div>
            </div>
            <button id="enviarAvisosLicencia">Enviar avisos</button>
        </section>

        <section id="new-visado-section" class="hidden">
            <h2>Nueva Renovación de Visado</h2>
            <form id="formVisado">
                <label for="nombreVisado">Nombre</label>
                <input type="text" id="nombreVisado" name="nombre" required>

                <label for="dniVisado">DNI</label>
                <input type="text" id="dniVisado" name="dni" required>

                <label for="telVisado">Teléfono</label>
                <input type="text" id="telVisado" name="tel">

                <label for="mailVisado">Correo Electrónico</label>
                <input type="email" id="mailVisado" name="mail">

                <label for="mesVisado">Mes de Caducidad</label>
                <select id="mesVisado" name="mes">
                    <option value="">-- Seleccionar --</option>
                    <option value="enero">Enero</option>
                    <option value="febrero">Febrero</option>
                    <option value="marzo">Marzo</option>
                    <option value="abril">Abril</option>
                    <option value="mayo">Mayo</option>
                    <option value="junio">Junio</option>
                    <option value="julio">Julio</option>
                    <option value="agosto">Agosto</option>
                    <option value="septiembre">Septiembre</option>
                    <option value="octubre">Octubre</option>
                    <option value="noviembre">Noviembre</option>
                    <option value="diciembre">Diciembre</option>
                </select>

                <label for="tipoVisado">Tipo de Visado</label>
                <select id="tipoVisado" name="tipo">
                    <option value="">-- Seleccionar --</option>
                    <option value="MDP">MDP</option>
                    <option value="MDL">MDL</option>
                    <option value="OT">OT</option>
                    <option value="MPC">MPC</option>
                </select>

                <button type="submit">Guardar Renovación</button>
            </form>
        </section>

        <section id="listado-visado-section" class="hidden">
            <h2>Listado de Renovaciones de Visados</h2>
            <div class="filter-bar">
                <input type="text" id="buscarVisado" placeholder="Buscar...">
                <select id="fMesVisado">
                    <option value="">Mes (Todos)</option>
                    <option value="enero">Enero</option>
                    <option value="febrero">Febrero</option>
                    <option value="marzo">Marzo</option>
                    <option value="abril">Abril</option>
                    <option value="mayo">Mayo</option>
                    <option value="junio">Junio</option>
                    <option value="julio">Julio</option>
                    <option value="agosto">Agosto</option>
                    <option value="septiembre">Septiembre</option>
                    <option value="octubre">Octubre</option>
                    <option value="noviembre">Noviembre</option>
                    <option value="diciembre">Diciembre</option>
                </select>
                <select id="fTipoVisado">
                    <option value="">Tipo (Todos)</option>
                    <option value="MDP">MDP</option>
                    <option value="MDL">MDL</option>
                    <option value="OT">OT</option>
                    <option value="MPC">MPC</option>
                </select>
                <label for="pageSizeVisado">Mostrar</label>
                <select id="pageSizeVisado">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="0">Todos</option>
                </select>
                <button id="importBtnVisado">Importar CSV</button>
                <button id="exportBtnVisado">Exportar CSV</button>
                <input type="file" id="csvFileVisado" accept=".csv" style="display: none;">
                <button id="clearStorageBtnVisado">Limpiar Local Storage</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th data-key="nombre">Nombre</th>
                        <th data-key="dni">DNI</th>
                        <th data-key="tel">Teléfono</th>
                        <th data-key="mail">Correo Electrónico</th>
                        <th data-key="mes">Mes</th>
                        <th data-key="tipo">Tipo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tbodyVisado"></tbody>
            </table>
            <div id="pagination-controls-visado" class="pagination-controls">
                <button id="prevPageBtnVisado">Anterior</button>
                <span id="pageInfoVisado" class="pageInfo">Página 1 de 1</span>
                <button id="nextPageBtnVisado">Siguiente</button>
            </div>

            <h2>Avisos masivos para Visados</h2>
            <hr>
            <div class="controls-row">
                <div>
                    <label for="mesAvisoVisado">Mes</label>
                    <select id="mesAvisoVisado">
                        <option value="">-- Todos --</option>
                        <option value="enero">Enero</option>
                        <option value="febrero">Febrero</option>
                        <option value="marzo">Marzo</option>
                        <option value="abril">Abril</option>
                        <option value="mayo">Mayo</option>
                        <option value="junio">Junio</option>
                        <option value="julio">Julio</option>
                        <option value="agosto">Agosto</option>
                        <option value="septiembre">Septiembre</option>
                        <option value="octubre">Octubre</option>
                        <option value="noviembre">Noviembre</option>
                        <option value="diciembre">Diciembre</option>
                    </select>
                </div>
                <div>
                    <label for="tipoAvisoVisado">Tipo</label>
                    <select id="tipoAvisoVisado">
                        <option value="">-- Todos --</option>
                        <option value="MDP">MDP</option>
                        <option value="MDL">MDL</option>
                        <option value="OT">OT</option>
                        <option value="MPC">MPC</option>
                    </select>
                </div>
                <div>
                    <label for="canalAvisoVisado">Canal</label>
                    <select id="canalAvisoVisado">
                        <option value="email">Email</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="ambos">Ambos</option>
                    </select>
                </div>
                <div>
                    <label for="daysBeforeMassiveVisado">Días de antelación</label>
                    <input type="number" id="daysBeforeMassiveVisado" value="30" min="0">
                </div>
            </div>
            <button id="enviarAvisosVisado">Enviar avisos</button>
        </section>

        <section id="plantillas-section" class="hidden">
            <h2>Plantillas de Avisos</h2>
            <hr>
            <div class="controls-row">
                <div>
                    <label for="templateCardType">Tipo de Caducidad</label>
                    <select id="templateCardType">
                        <option value="tacografo">Tarjeta de Tacógrafo</option>
                        <option value="licencia">Licencia Comunitaria</option>
                        <option value="visado">Renovación de Visado</option>
                    </select>
                </div>
                <div id="templateCategoryContainer">
                    <label for="categoriaTpl">Categoría</label>
                    <select id="categoriaTpl">
                        <!-- Options will be loaded dynamically -->
                    </select>
                </div>
                <div>
                    <label for="canalTpl">Canal</label>
                    <select id="canalTpl">
                        <option value="email">Email</option>
                        <option value="whatsapp">WhatsApp</option>
                    </select>
                </div>
            </div>
            <div id="emailSubjectField" style="display: none;">
                <label for="asuntoTpl">Asunto del Email</label>
                <input type="text" id="asuntoTpl" placeholder="Asunto del correo...">
            </div>
            <div id="tagContainer">
                <!-- Tags will be loaded dynamically -->
            </div>
            <textarea id="plantilla" rows="10" placeholder="Escribe aquí tu mensaje..."></textarea>
            <button id="guardarTpl">Guardar Plantilla</button>
        </section>

        <div id="toast-container"></div>

        <!-- Custom Confirmation Modal -->
        <div id="customConfirmModal" class="modal-overlay hidden">
            <div class="modal-content">
                <p id="confirmMessage"></p>
                <div class="modal-actions">
                    <button id="confirmYesBtn">Sí</button>
                    <button id="confirmNoBtn">No</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        (function () {
            /* ---------- CONSTANTES ---------- */
            const DB_KEY_TACOGRAFO = 'tacografoDigitalCards';
            const DB_KEY_LICENCIA = 'licenciasComunitariasCards';
            const DB_KEY_VISADO = 'visadoRenovations'; // New DB key for visados

            const TPL_EMAIL_BODY_PREFIX = 'tpl_email_body_';
            const TPL_EMAIL_SUBJECT_PREFIX = 'tpl_email_subject_';
            const TPL_WHATSAPP_PREFIX = 'tpl_whatsapp_';

            const CATEGORIES_TACOGRAFO = ['CONDUCTOR', 'EMPRESA', 'CENTRO DE ENSAYO'];
            const CATEGORIES_LICENCIA = ['LICENCIA COMUNITARIA'];
            const CATEGORIES_VISADO = ['MDP', 'MDL', 'OT', 'MPC']; // Categories for visados

            const MONTH_NAMES = {
                'enero': 'Enero', 'febrero': 'Febrero', 'marzo': 'Marzo', 'abril': 'Abril',
                'mayo': 'Mayo', 'junio': 'Junio', 'julio': 'Julio', 'agosto': 'Agosto',
                'septiembre': 'Septiembre', 'octubre': 'Octubre', 'noviembre': 'Noviembre', 'diciembre': 'Diciembre'
            };

            const DEFAULT_TAGS_TACOGRAFO = [
                { text: 'Nombre', tag: '{{nombre}}' },
                { text: 'DNI', tag: '{{dni}}' },
                { text: 'Fecha de Caducidad', tag: '{{fechaCaducidad}}' },
                { text: 'Categoría', tag: '{{categoria}}' },
                { text: 'Mediador', tag: '{{mediador}}' },
                { text: 'Teléfono', tag: '{{telefono}}' },
                { text: 'Correo Electrónico', tag: '{{email}}' }
            ];

            const DEFAULT_TAGS_LICENCIA = [
                { text: 'Nombre', tag: '{{nombre}}' },
                { text: 'CIF', tag: '{{cif}}' },
                { text: 'Fecha de Caducidad', tag: '{{fechaCaducidad}}' },
                { text: 'Teléfono', tag: '{{telefono}}' },
                { text: 'Correo Electrónico', tag: '{{email}}' }
            ];

            const DEFAULT_TAGS_VISADO = [ // Tags for visados
                { text: 'Nombre', tag: '{{nombre}}' },
                { text: 'DNI', tag: '{{dni}}' },
                { text: 'Teléfono', tag: '{{tel}}' },
                { text: 'Correo Electrónico', tag: '{{mail}}' },
                { text: 'Mes de Caducidad', tag: '{{mes}}' },
                { text: 'Tipo de Visado', tag: '{{tipo}}' }
            ];

            /* ---------- ESTADO GLOBAL ---------- */
            let dbTacografo = JSON.parse(localStorage.getItem(DB_KEY_TACOGRAFO) || '[]');
            let dbLicencia = JSON.parse(localStorage.getItem(DB_KEY_LICENCIA) || '[]');
            let dbVisado = JSON.parse(localStorage.getItem(DB_KEY_VISADO) || '[]'); // New DB for visados

            let currentSortKey = {
                tacografo: 'nombre',
                licencia: 'nombre',
                visado: 'nombre'
            };
            let currentSortAscending = {
                tacografo: true,
                licencia: true,
                visado: true
            };
            let currentPage = {
                tacografo: 1,
                licencia: 1,
                visado: 1
            };
            let totalPages = {
                tacografo: 1,
                licencia: 1,
                visado: 1
            };
            let currentCardTypeDashboard = 'tacografo'; // Default for dashboard card clicks


            /* ---------- HELPERS ---------- */
            const $ = id => document.getElementById(id);

            function showToast(message) {
                const toastContainer = $('toast-container');
                const toast = document.createElement('div');
                toast.classList.add('toast');
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 2500);
            }

            // Custom Confirmation Modal Logic
            let resolveCustomConfirm;

            function showCustomConfirm(message) {
                return new Promise((resolve) => {
                    resolveCustomConfirm = resolve;
                    $('confirmMessage').textContent = message;
                    $('customConfirmModal').classList.remove('hidden');
                });
            }

            function hideCustomConfirm() {
                $('customConfirmModal').classList.add('hidden');
            }


            function saveDatabase(type) {
                if (type === 'tacografo') {
                    localStorage.setItem(DB_KEY_TACOGRAFO, JSON.stringify(dbTacografo));
                } else if (type === 'licencia') {
                    localStorage.setItem(DB_KEY_LICENCIA, JSON.stringify(dbLicencia));
                } else if (type === 'visado') { // Save visado database
                    localStorage.setItem(DB_KEY_VISADO, JSON.stringify(dbVisado));
                }
            }

            function getDatabase(type) {
                if (type === 'tacografo') return dbTacografo;
                if (type === 'licencia') return dbLicencia;
                if (type === 'visado') return dbVisado; // Get visado database
                return [];
            }

            function generateUUID() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 4);
            }

            // Consolidated fillTemplate function
            function fillTemplate(template, rec, cardType) {
                let filledTemplate = template
                    .replace(/{{nombre}}/g, rec.nombre || '');

                if (cardType === 'tacografo' || cardType === 'licencia') {
                    filledTemplate = filledTemplate
                        .replace(/{{fechaCaducidad}}/g, rec.fechaCaducidad || '')
                        .replace(/{{telefono}}/g, rec.telefono || '')
                        .replace(/{{email}}/g, rec.email || '');

                    if (cardType === 'tacografo') {
                        filledTemplate = filledTemplate
                            .replace(/{{dni}}/g, rec.dni || '')
                            .replace(/{{categoria}}/g, rec.categoria || '')
                            .replace(/{{mediador}}/g, rec.mediador || '');
                    } else if (cardType === 'licencia') {
                        filledTemplate = filledTemplate
                            .replace(/{{cif}}/g, rec.cif || '');
                    }
                } else if (cardType === 'visado') {
                    filledTemplate = filledTemplate
                        .replace(/{{dni}}/g, rec.dni || '')
                        .replace(/{{tel}}/g, rec.tel || '')
                        .replace(/{{mail}}/g, rec.mail || '')
                        .replace(/{{mes}}/g, MONTH_NAMES[rec.mes] || '')
                        .replace(/{{tipo}}/g, rec.tipo || '');
                }
                return filledTemplate;
            }

            function formatDate(dateString) {
                if (!dateString) return '';
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            }

            function getDaysUntil(dateString) {
                if (!dateString) return Infinity; // Treat as never expiring or irrelevant
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize to start of day
                const [year, month, day] = dateString.split('-').map(Number);
                const expiryDate = new Date(year, month - 1, day);
                expiryDate.setHours(0, 0, 0, 0); // Normalize to start of day

                const diffTime = expiryDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            }

            // Function to get the month number from its Spanish name
            function getMonthNumber(monthName) {
                const months = {
                    'enero': 1, 'febrero': 2, 'marzo': 3, 'abril': 4, 'mayo': 5, 'junio': 6,
                    'julio': 7, 'agosto': 8, 'septiembre': 9, 'octubre': 10, 'noviembre': 11, 'diciembre': 12
                };
                return months[monthName.toLowerCase()];
            }

            // New helper function to remove accents
            function removeAccents(str) {
                return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            }

            /* ---------- NAVEGACIÓN Y SECCIONES ---------- */
            const sections = document.querySelectorAll('.main-content section');
            const navLinks = document.querySelectorAll('.sidebar nav ul li a');
            const submenus = document.querySelectorAll('.sidebar nav ul li .submenu');

            function showSection(id) {
                sections.forEach(section => {
                    section.classList.add('hidden');
                });
                const targetSection = $(id);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                } else {
                    console.error(`Section with ID '${id}' not found.`);
                }
            }

            function setActiveLink(activeId) {
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    // Collapse all submenus
                    if (link.nextElementSibling && link.nextElementSibling.classList.contains('submenu')) {
                        link.nextElementSibling.classList.remove('active');
                    }
                });

                const activeLink = $(activeId);
                if (activeLink) {
                    activeLink.classList.add('active');
                    // Expand parent submenu if it exists
                    const parentSubmenu = activeLink.closest('.submenu');
                    if (parentSubmenu) {
                        const parentLink = parentSubmenu.previousElementSibling;
                        if (parentLink) {
                            parentLink.classList.add('active');
                        }
                        parentSubmenu.classList.add('active');
                    }
                } else {
                    console.warn(`Navigation link with ID '${activeId}' not found.`);
                }
            }

            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    let sectionIdToShow = '';
                    let linkIdToActivate = this.id;

                    // Special handling for main menu items that have submenus
                    if (this.id === 'nav-tacografo') {
                        sectionIdToShow = 'listado-tacografo-section';
                        linkIdToActivate = 'nav-listado-tacografo';
                    } else if (this.id === 'nav-licencia') {
                        sectionIdToShow = 'listado-licencia-section';
                        linkIdToActivate = 'nav-listado-licencia';
                    } else if (this.id === 'nav-visados') {
                        sectionIdToShow = 'listado-visado-section';
                        linkIdToActivate = 'nav-listado-visado';
                    } else {
                        // For dashboard, plantillas, and direct sub-menu items
                        sectionIdToShow = this.id.replace('nav-', '') + '-section';
                    }

                    showSection(sectionIdToShow);
                    setActiveLink(linkIdToActivate);

                    // If it's a main menu item with a submenu, toggle its visibility
                    if (this.nextElementSibling && this.nextElementSibling.classList.contains('submenu')) {
                        this.nextElementSibling.classList.toggle('active');
                    }
                });
            });

            /* ---------- MANEJO DE TABLAS (Genérico) ---------- */
            function sortTable(tableType, key) {
                let db = getDatabase(tableType);
                const isAsc = currentSortKey[tableType] !== key || !currentSortAscending[tableType];

                db.sort((a, b) => {
                    const valA = a[key] ? String(a[key]).toLowerCase() : '';
                    const valB = b[key] ? String(b[key]).toLowerCase() : '';

                    if (valA < valB) return isAsc ? -1 : 1;
                    if (valA > valB) return isAsc ? 1 : -1;
                    return 0;
                });

                currentSortKey[tableType] = key;
                currentSortAscending[tableType] = isAsc;
                saveDatabase(tableType);
                drawTable(tableType);
            }

            function setupTableSorting(tableType) {
                // More robust selection of table headers
                const tableHeadElement = document.querySelector(`#listado-${tableType}-section table thead`);
                if (tableHeadElement) {
                    const headers = tableHeadElement.querySelectorAll('th[data-key]');
                    headers.forEach(header => {
                        header.addEventListener('click', () => sortTable(tableType, header.dataset.key));
                    });
                } else {
                    console.warn(`Table head for type '${tableType}' not found for sorting setup.`);
                }
            }

            function drawTable(type) {
                let db = getDatabase(type);
                const tbody = $(`tbody${capitalizeFirstLetter(type)}`);
                const searchInput = $(`buscar${capitalizeFirstLetter(type)}`);
                const pageSizeSelect = $(`pageSize${capitalizeFirstLetter(type)}`);
                const pageInfoSpan = $(`pageInfo${capitalizeFirstLetter(type)}`);

                let filteredDb = [...db];
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

                // Apply general search filter
                if (searchTerm) {
                    filteredDb = filteredDb.filter(rec =>
                        Object.values(rec).some(val =>
                            String(val).toLowerCase().includes(searchTerm)
                        )
                    );
                }

                // Apply specific filters based on type
                if (type === 'tacografo') {
                    const categoryFilter = $('fCategoriaTacografo');
                    if (categoryFilter && categoryFilter.value) {
                        filteredDb = filteredDb.filter(rec => rec.categoria === categoryFilter.value);
                    }
                } else if (type === 'licencia') {
                    // No specific filters yet for licenses, but keep structure for future
                } else if (type === 'visado') {
                    const mesFilter = $('fMesVisado');
                    const tipoFilter = $('fTipoVisado');
                    if (mesFilter && mesFilter.value) {
                        filteredDb = filteredDb.filter(rec => rec.mes === mesFilter.value);
                    }
                    if (tipoFilter && tipoFilter.value) {
                        filteredDb = filteredDb.filter(rec => rec.tipo === tipoFilter.value);
                    }
                }

                // Pagination logic
                const pageSize = pageSizeSelect ? parseInt(pageSizeSelect.value) : (filteredDb.length || 10);
                totalPages[type] = pageSize === 0 ? 1 : Math.ceil(filteredDb.length / pageSize);
                if (currentPage[type] > totalPages[type]) currentPage[type] = totalPages[type];
                if (currentPage[type] < 1) currentPage[type] = 1;

                const start = pageSize === 0 ? 0 : (currentPage[type] - 1) * pageSize;
                const end = pageSize === 0 ? filteredDb.length : start + pageSize;
                const paginatedDb = filteredDb.slice(start, end);

                if (tbody) { // Added null check for tbody
                    tbody.innerHTML = '';
                    if (paginatedDb.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No hay registros para mostrar.</td></tr>`;
                    }

                    const fieldsToRender = {
                        tacografo: ['nombre', 'dni', 'fechaCaducidad', 'categoria', 'mediador', 'telefono', 'email'],
                        licencia: ['nombre', 'cif', 'fechaCaducidad', 'telefono', 'email'],
                        visado: ['nombre', 'dni', 'tel', 'mail', 'mes', 'tipo']
                    };

                    paginatedDb.forEach(rec => {
                        const row = tbody.insertRow();
                        row.setAttribute('data-id', rec.id); // Add data-id to row for easy lookup

                        fieldsToRender[type].forEach(field => {
                            const cell = row.insertCell();
                            cell.setAttribute('data-field', field);
                            cell.setAttribute('data-original', rec[field] || ''); // Store original value

                            let displayValue = rec[field] || '';
                            if (field === 'fechaCaducidad') {
                                displayValue = formatDate(displayValue);
                            } else if (field === 'mes') {
                                displayValue = MONTH_NAMES[displayValue] || displayValue;
                            }
                            cell.textContent = displayValue;
                        });

                        const actionsCell = row.insertCell();
                        actionsCell.classList.add('actions');

                        const editBtn = document.createElement('button');
                        editBtn.innerHTML = '<span class="material-icons">✏️</span>';
                        editBtn.title = 'Editar';
                        editBtn.classList.add('edit-btn'); // Add a class to identify
                        editBtn.onclick = () => toggleInlineEdit(type, rec.id, row); // Pass the row element

                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = '<span class="material-icons">🗑️</span>';
                        deleteBtn.title = 'Eliminar';
                        deleteBtn.onclick = () => deleteRecord(type, rec.id);

                        const emailBtn = document.createElement('button');
                        emailBtn.innerHTML = '<span class="material-icons">✉️</span>';
                        emailBtn.title = 'Enviar Email';
                        emailBtn.onclick = () => sendNotification(type, rec.id, 'email');

                        const whatsappBtn = document.createElement('button');
                        whatsappBtn.innerHTML = '<span class="material-icons">💬</span>';
                        whatsappBtn.title = 'Enviar WhatsApp';
                        whatsappBtn.onclick = () => sendNotification(type, rec.id, 'whatsapp');

                        actionsCell.appendChild(editBtn);
                        actionsCell.appendChild(deleteBtn);
                        actionsCell.appendChild(emailBtn);
                        actionsCell.appendChild(whatsappBtn);
                    });
                }


                if (pageInfoSpan) {
                    pageInfoSpan.textContent = `Página ${currentPage[type]} de ${totalPages[type]}`;
                    const prevBtn = $(`prevPageBtn${capitalizeFirstLetter(type)}`);
                    const nextBtn = $(`nextPageBtn${capitalizeFirstLetter(type)}`);
                    if (prevBtn) prevBtn.disabled = currentPage[type] === 1;
                    if (nextBtn) nextBtn.disabled = currentPage[type] === totalPages[type];
                }
            }

            function setupPagination(type) {
                const prevBtn = $(`prevPageBtn${capitalizeFirstLetter(type)}`);
                const nextBtn = $(`nextPageBtn${capitalizeFirstLetter(type)}`);
                const pageSizeSelect = $(`pageSize${capitalizeFirstLetter(type)}`);
                const searchInput = $(`buscar${capitalizeFirstLetter(type)}`);

                if (prevBtn) prevBtn.addEventListener('click', () => { currentPage[type]--; drawTable(type); });
                if (nextBtn) nextBtn.addEventListener('click', () => { currentPage[type]++; drawTable(type); });
                if (pageSizeSelect) pageSizeSelect.addEventListener('change', () => { currentPage[type] = 1; drawTable(type); });
                if (searchInput) searchInput.addEventListener('keyup', () => { currentPage[type] = 1; drawTable(type); });

                if (type === 'tacografo') {
                    const fCategoriaTacografo = $('fCategoriaTacografo');
                    if (fCategoriaTacografo) fCategoriaTacografo.addEventListener('change', () => { currentPage[type] = 1; drawTable(type); });
                } else if (type === 'visado') {
                    const fMesVisado = $('fMesVisado');
                    const fTipoVisado = $('fTipoVisado');
                    if (fMesVisado) fMesVisado.addEventListener('change', () => { currentPage[type] = 1; drawTable(type); });
                    if (fTipoVisado) fTipoVisado.addEventListener('change', () => { currentPage[type] = 1; drawTable(type); });
                }
            }

            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }

            /* ---------- INLINE EDITING FUNCTIONS ---------- */
            function toggleInlineEdit(type, id, rowElement) {
                const record = getDatabase(type).find(r => r.id === id);
                if (!record) return;

                const isEditing = rowElement.classList.contains('editing');

                if (isEditing) {
                    // This function is only for initiating edit mode.
                    // Saving/cancelling is handled by separate functions.
                    return;
                }

                // Enter edit mode
                rowElement.classList.add('editing');

                const cells = rowElement.querySelectorAll('[data-field]');
                cells.forEach(cell => {
                    const field = cell.dataset.field;
                    const originalValue = record[field] || ''; // Use the actual record value

                    let inputElement;
                    if (field === 'fechaCaducidad') {
                        inputElement = document.createElement('input');
                        inputElement.type = 'date';
                        inputElement.value = originalValue;
                    } else if (field === 'categoria' && type === 'tacografo') {
                        inputElement = document.createElement('select');
                        CATEGORIES_TACOGRAFO.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat;
                            option.textContent = cat;
                            inputElement.appendChild(option);
                        });
                        inputElement.value = originalValue;
                    } else if (field === 'mes' && type === 'visado') {
                        inputElement = document.createElement('select');
                        Object.keys(MONTH_NAMES).forEach(monthKey => {
                            const option = document.createElement('option');
                            option.value = monthKey;
                            option.textContent = MONTH_NAMES[monthKey];
                            inputElement.appendChild(option);
                        });
                        inputElement.value = originalValue;
                    } else if (field === 'tipo' && type === 'visado') {
                        inputElement = document.createElement('select');
                        CATEGORIES_VISADO.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat;
                            option.textContent = cat;
                            inputElement.appendChild(option);
                        });
                        inputElement.value = originalValue;
                    } else {
                        inputElement = document.createElement('input');
                        inputElement.type = (field === 'email' || field === 'mail') ? 'email' : 'text';
                        inputElement.value = originalValue;
                    }
                    inputElement.classList.add('inline-edit-input'); // Add a class for styling/identification
                    cell.innerHTML = ''; // Clear content
                    cell.appendChild(inputElement);
                });

                // Change action buttons
                const actionsCell = rowElement.querySelector('.actions');
                actionsCell.innerHTML = ''; // Clear existing buttons

                const saveBtn = document.createElement('button');
                saveBtn.innerHTML = '<span class="material-icons">💾</span>';
                saveBtn.title = 'Guardar';
                saveBtn.onclick = () => saveInlineEdit(type, id, rowElement);

                const cancelBtn = document.createElement('button');
                cancelBtn.innerHTML = '<span class="material-icons">❌</span>';
                cancelBtn.title = 'Cancelar';
                cancelBtn.onclick = () => cancelInlineEdit(type, id, rowElement);

                actionsCell.appendChild(saveBtn);
                actionsCell.appendChild(cancelBtn);
            }

            function saveInlineEdit(type, id, rowElement) {
                let db = getDatabase(type);
                const recordIndex = db.findIndex(r => r.id === id);
                if (recordIndex === -1) return;

                const updatedRecord = { ...db[recordIndex] }; // Create a copy

                const cells = rowElement.querySelectorAll('[data-field]');
                cells.forEach(cell => {
                    const field = cell.dataset.field;
                    const inputElement = cell.querySelector('.inline-edit-input');
                    if (inputElement) {
                        updatedRecord[field] = inputElement.value;
                    }
                });

                // Update the database
                db[recordIndex] = updatedRecord;
                saveDatabase(type);
                showToast('Registro actualizado.');
                drawTable(type); // Re-draw the table to revert to display mode
                updateDashboard();
            }

            function cancelInlineEdit(type, id, rowElement) {
                rowElement.classList.remove('editing');
                drawTable(type); // Re-draw the table to revert to original display
            }


            /* ---------- FORMS (Original, not for inline editing) ---------- */
            function setupForm(formId, dbKey, fields, isVisadoForm = false) {
                const form = $(formId);
                if (!form) return;

                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const newRecord = { id: generateUUID() };
                    fields.forEach(field => {
                        const inputElement = $(`${field}${capitalizeFirstLetter(dbKey)}`);
                        if (inputElement) {
                            newRecord[field] = inputElement.value;
                        }
                    });

                    // Special handling for month input for visados
                    if (isVisadoForm && newRecord.mes) {
                        const mesSelect = $(`mes${capitalizeFirstLetter(dbKey)}`);
                        if (mesSelect && mesSelect.selectedIndex !== -1) {
                            const monthName = Object.keys(MONTH_NAMES).find(key => MONTH_NAMES[key] === mesSelect.options[mesSelect.selectedIndex].text);
                            newRecord.mes = monthName;
                        }
                    }

                    let db = getDatabase(dbKey);
                    db.push(newRecord);
                    saveDatabase(dbKey);
                    drawTable(dbKey);
                    form.reset();
                    showToast('Registro guardado exitosamente.');
                    updateDashboard();
                });
            }

            // The original editRecord function is no longer used for inline editing.
            // It's still here for historical context, but not called.
            function editRecord(type, id) {
                // This function is now superseded by toggleInlineEdit for table rows.
                // If you intend to use a separate form for editing, this logic would apply.
                // For now, it's a placeholder to avoid breaking existing calls if any.
                console.warn(`editRecord(${type}, ${id}) called. This function is typically replaced by inline editing.`);
                const db = getDatabase(type);
                const record = db.find(rec => rec.id === id);
                if (!record) return;

                // Example of what it *used* to do (navigate to form):
                // if (type === 'tacografo') {
                //     showSection('new-tacografo-section');
                //     setActiveLink('nav-new-tacografo');
                //     if ($('nombreTacografo')) $('nombreTacografo').value = record.nombre;
                //     // ... fill other fields
                // }
                // deleteRecord(type, id, false); // Delete original after loading for editing
            }


            async function deleteRecord(type, id) { // Made async to use custom confirm
                const recordToDelete = getDatabase(type).find(rec => rec.id === id);
                if (!recordToDelete) return;

                const message = `¿Estás seguro de que quieres eliminar el registro de "${recordToDelete.nombre}"?`;
                const shouldDelete = await showCustomConfirm(message); // Await user decision

                if (!shouldDelete) {
                    return;
                }
                let db = getDatabase(type);
                if (type === 'tacografo') {
                    dbTacografo = dbTacografo.filter(rec => rec.id !== id);
                } else if (type === 'licencia') {
                    dbLicencia = dbLicencia.filter(rec => rec.id !== id);
                } else if (type === 'visado') {
                    dbVisado = dbVisado.filter(rec => rec.id !== id);
                }
                saveDatabase(type);
                drawTable(type);
                showToast('Registro eliminado exitosamente.');
                updateDashboard();
            }

            /* ---------- IMPORT/EXPORT CSV ---------- */
            function setupCsvImportExport(type, fields) {
                const importBtn = $(`importBtn${capitalizeFirstLetter(type)}`);
                const exportBtn = $(`exportBtn${capitalizeFirstLetter(type)}`);
                const csvFile = $(`csvFile${capitalizeFirstLetter(type)}`);
                const clearStorageBtn = $(`clearStorageBtn${capitalizeFirstLetter(type)}`); // Only for Visado

                if (importBtn) {
                    importBtn.addEventListener('click', () => csvFile.click());
                    csvFile.addEventListener('change', (event) => importCSV(event, type, fields));
                }

                if (exportBtn) {
                    exportBtn.addEventListener('click', () => exportCSV(type, fields));
                }

                if (clearStorageBtn) { // Only for Visado
                    clearStorageBtn.addEventListener('click', async () => { // Made async to use custom confirm
                        const message = '¿Estás seguro de que quieres borrar TODOS los datos de Visados? Esta acción es irreversible.';
                        const shouldClear = await showCustomConfirm(message); // Await user decision

                        if (shouldClear) {
                            if (type === 'visado') {
                                localStorage.removeItem(DB_KEY_VISADO);
                                dbVisado = [];
                            }
                            drawTable(type);
                            showToast('Todos los datos han sido borrados.');
                            updateDashboard();
                        }
                    });
                }
            }

            async function importCSV(event, type, fields) { // Made async
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async function (e) { // Made onload async
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    if (lines.length <= 1) {
                        showToast('El archivo CSV está vacío o solo contiene encabezados.');
                        event.target.value = ''; // Clear file input
                        return;
                    }

                    // Define a specific mapping from normalized CSV headers to internal field names for each type
                    const importFieldMap = {};
                    if (type === 'tacografo') {
                        importFieldMap['nombre'] = 'nombre';
                        importFieldMap['dni'] = 'dni';
                        importFieldMap['fechacaducidad'] = 'fechaCaducidad';
                        importFieldMap['fecha de caducidad'] = 'fechaCaducidad'; // Handle common variations
                        importFieldMap['categoria'] = 'categoria';
                        importFieldMap['mediador'] = 'mediador';
                        importFieldMap['telefono'] = 'telefono';
                        importFieldMap['email'] = 'email';
                        importFieldMap['correo electronico'] = 'email';
                    } else if (type === 'licencia') {
                        importFieldMap['nombre'] = 'nombre';
                        importFieldMap['cif'] = 'cif';
                        importFieldMap['fechacaducidad'] = 'fechaCaducidad';
                        importFieldMap['fecha de caducidad'] = 'fechaCaducidad';
                        importFieldMap['telefono'] = 'telefono';
                        importFieldMap['email'] = 'email';
                        importFieldMap['correo electronico'] = 'email';
                    } else if (type === 'visado') {
                        importFieldMap['nombre'] = 'nombre';
                        importFieldMap['dni'] = 'dni';
                        importFieldMap['telefono'] = 'tel'; // Map CSV 'telefono' to internal 'tel'
                        importFieldMap['tel'] = 'tel';       // Map CSV 'tel' to internal 'tel'
                        importFieldMap['email'] = 'mail';     // Map CSV 'email' to internal 'mail'
                        importFieldMap['correo electronico'] = 'mail'; // Map CSV 'correo electronico' to internal 'mail'
                        importFieldMap['mail'] = 'mail';     // Map CSV 'mail' to internal 'mail'
                        importFieldMap['mes'] = 'mes';
                        importFieldMap['tipo'] = 'tipo';
                    }

                    const actualHeaders = lines[0].split(';').map(h => removeAccents(h.trim().toLowerCase()));

                    // Validate headers against the expected internal fields
                    const expectedInternalFields = fields.map(f => f.toLowerCase());
                    const actualInternalFields = actualHeaders.map(h => importFieldMap[h]).filter(Boolean); // Get mapped internal fields

                    // Check if all *required* fields are present in the mapped actual headers
                    const allRequiredFieldsPresent = expectedInternalFields.every(field => actualInternalFields.includes(field));
                    // Allow for more columns in CSV than expected fields, but not less.
                    const headerLengthsCompatible = actualHeaders.length >= fields.length;

                    if (!allRequiredFieldsPresent || !headerLengthsCompatible) {
                        showToast('Error: El formato del archivo CSV no coincide con el esperado. Asegúrese de usar punto y coma (;) como delimitador y que los encabezados coincidan con los campos de la tabla (sin acentos).');
                        console.error('Expected internal fields:', expectedInternalFields);
                        console.error('Actual mapped internal fields:', actualInternalFields);
                        console.error('Actual CSV headers (processed):', actualHeaders);
                        event.target.value = ''; // Clear file input
                        return;
                    }

                    const recordsToProcess = [];
                    let malformedRowsSkipped = 0;

                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(';');
                        if (values.length < fields.length) { // Check if enough values for expected fields
                            console.warn(`Skipping malformed row: ${lines[i]}`);
                            malformedRowsSkipped++;
                            continue;
                        }
                        const record = { id: generateUUID() };
                        actualHeaders.forEach((header, index) => {
                            let value = values[index] ? values[index].trim() : ''; // Handle empty values
                            const internalField = importFieldMap[header];

                            if (internalField) { // Only process if a mapping exists
                                // Special handling for date and month formats
                                if (internalField === 'fechaCaducidad') {
                                    const parts = value.split('/');
                                    if (parts.length === 3) {
                                        value = `${parts[2]}-${parts[1]}-${parts[0]}`; // Convert DD/MM/YYYY to YYYY-MM-DD
                                    }
                                } else if (internalField === 'mes') {
                                    value = Object.keys(MONTH_NAMES).find(key => MONTH_NAMES[key].toLowerCase() === value.toLowerCase()) || value;
                                }
                                record[internalField] = value;
                            } else {
                                // If a header exists in CSV but is not in our map, it's ignored.
                                console.warn(`CSV header "${header}" not mapped for type "${type}". Skipping this column.`);
                            }
                        });
                        recordsToProcess.push(record);
                    }

                    let db = getDatabase(type);
                    let addedCount = 0;
                    let skippedDuplicateCount = 0;

                    for (const newRec of recordsToProcess) {
                        let isDuplicate = false;
                        let duplicateField = '';
                        let duplicateValue = '';

                        if (type === 'tacografo') {
                            isDuplicate = db.some(existingRec => existingRec.dni === newRec.dni);
                            duplicateField = 'DNI';
                            duplicateValue = newRec.dni;
                        } else if (type === 'licencia') {
                            isDuplicate = db.some(existingRec => existingRec.cif === newRec.cif);
                            duplicateField = 'CIF';
                            duplicateValue = newRec.cif;
                        } else if (type === 'visado') {
                            isDuplicate = db.some(existingRec => existingRec.dni === newRec.dni); // Visado uses DNI for duplication check
                            duplicateField = 'DNI';
                            duplicateValue = newRec.dni;
                        }

                        if (isDuplicate) {
                            const message = `El registro con ${duplicateField} "${duplicateValue}" (Nombre: ${newRec.nombre || 'N/A'}) ya existe. ¿Desea añadirlo de todos modos?`;
                            const shouldAdd = await showCustomConfirm(message); // Await user decision

                            if (shouldAdd) {
                                db.push(newRec);
                                addedCount++;
                            } else {
                                skippedDuplicateCount++;
                            }
                        } else {
                            db.push(newRec);
                            addedCount++;
                        }
                    }

                    saveDatabase(type);
                    drawTable(type);
                    let message = `${addedCount} registros importados.`;
                    if (skippedDuplicateCount > 0) {
                        message += ` ${skippedDuplicateCount} registros duplicados omitidos por decisión del usuario.`;
                    }
                     if (malformedRowsSkipped > 0) {
                        message += ` ${malformedRowsSkipped} filas mal formadas omitidas.`;
                    }
                    showToast(message);
                    event.target.value = ''; // Clear file input
                    updateDashboard();
                };
                reader.readAsText(file);
            }


            function exportCSV(type, fields) {
                const db = getDatabase(type);
                if (db.length === 0) {
                    showToast('No hay datos para exportar.');
                    return;
                }

                // Define a map for display names without accents
                const displayHeaderMap = {
                    'nombre': 'Nombre',
                    'dni': 'DNI',
                    'fechaCaducidad': 'Fecha de Caducidad',
                    'categoria': 'Categoria',
                    'mediador': 'Mediador',
                    'telefono': 'Telefono',
                    'email': 'Correo Electronico',
                    'cif': 'CIF',
                    'tel': 'Telefono', // Ensure 'tel' exports as 'Telefono'
                    'mail': 'Correo Electronico', // Ensure 'mail' exports as 'Correo Electronico'
                    'mes': 'Mes',
                    'tipo': 'Tipo'
                };

                const headers = fields.map(field => removeAccents(displayHeaderMap[field] || capitalizeFirstLetter(field)));

                const csvContent = "data:text/csv;charset=utf-8,"
                    + headers.join(';') + '\n'
                    + db.map(rec => fields.map(field => {
                        let value = rec[field] || '';
                        if (field === 'fechaCaducidad' && value) {
                            value = formatDate(value); // Convert YYYY-MM-DD to DD/MM/YYYY
                        } else if (field === 'mes' && value) {
                            value = MONTH_NAMES[value] || value; // Convert month key to display name
                        }
                        return `"${String(value).replace(/"/g, '""')}"`; // Enclose in quotes and escape
                    }).join(';')).join('\n');

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', `${type}_data.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('Datos exportados exitosamente.');
            }

            /* ---------- PLANTILLAS ---------- */
            const TPL_TAG_MAP = {
                'tacografo': DEFAULT_TAGS_TACOGRAFO,
                'licencia': DEFAULT_TAGS_LICENCIA,
                'visado': DEFAULT_TAGS_VISADO
            };

            function loadTemplate() {
                const templateCardTypeSelect = $('templateCardType');
                if (!templateCardTypeSelect) return;
                const cardType = templateCardTypeSelect.value;

                const canalTplSelect = $('canalTpl');
                if (!canalTplSelect) return;
                const canal = canalTplSelect.value;

                const categoriaTplSelect = $('categoriaTpl');
                const categoria = categoriaTplSelect ? categoriaTplSelect.value : 'default'; // Default if not found

                const templateKey = `${canal === 'email' ? TPL_EMAIL_BODY_PREFIX : TPL_WHATSAPP_PREFIX}${cardType}_${categoria}`;
                const subjectKey = `${TPL_EMAIL_SUBJECT_PREFIX}${cardType}_${categoria}`;

                if ($('plantilla')) $('plantilla').value = localStorage.getItem(templateKey) || '';
                if ($('asuntoTpl')) $('asuntoTpl').value = localStorage.getItem(subjectKey) || '';

                const emailSubjectField = $('emailSubjectField');
                if (emailSubjectField) {
                    if (canal === 'email') {
                        emailSubjectField.style.display = 'block';
                    } else {
                        emailSubjectField.style.display = 'none';
                    }
                }
                updateTemplateTags(cardType);
            }

            function saveTemplate() {
                const templateCardTypeSelect = $('templateCardType');
                if (!templateCardTypeSelect) return;
                const cardType = templateCardTypeSelect.value;

                const canalTplSelect = $('canalTpl');
                if (!canalTplSelect) return;
                const canal = canalTplSelect.value;

                const categoriaTplSelect = $('categoriaTpl');
                const categoria = categoriaTplSelect ? categoriaTplSelect.value : 'default';

                const templateKey = `${canal === 'email' ? TPL_EMAIL_BODY_PREFIX : TPL_WHATSAPP_PREFIX}${cardType}_${categoria}`;
                const subjectKey = `${TPL_EMAIL_SUBJECT_PREFIX}${cardType}_${categoria}`;

                if ($('plantilla')) localStorage.setItem(templateKey, $('plantilla').value);
                if (canal === 'email') {
                    if ($('asuntoTpl')) localStorage.setItem(subjectKey, $('asuntoTpl').value);
                } else {
                    localStorage.removeItem(subjectKey); // Clear subject if not email
                }
                showToast('Plantilla guardada.');
            }

            function updateTemplateCategories() {
                const templateCardTypeSelect = $('templateCardType');
                if (!templateCardTypeSelect) return;
                const cardType = templateCardTypeSelect.value;

                const categoriaTplSelect = $('categoriaTpl');
                if (!categoriaTplSelect) return;

                categoriaTplSelect.innerHTML = '';
                const templateCategoryContainer = $('templateCategoryContainer');
                if (templateCategoryContainer) templateCategoryContainer.style.display = 'block'; // Show by default

                let categories = [];
                if (cardType === 'tacografo') {
                    categories = CATEGORIES_TACOGRAFO;
                } else if (cardType === 'licencia') {
                    categories = CATEGORIES_LICENCIA; // Only one category for licenses, but keep select for consistency
                } else if (cardType === 'visado') {
                    categories = CATEGORIES_VISADO;
                } else {
                    if (templateCategoryContainer) templateCategoryContainer.style.display = 'none'; // Hide if no categories
                }

                if (categories.length > 0) {
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        categoriaTplSelect.appendChild(option);
                    });
                } else {
                    // Add a default "N/A" option if no specific categories
                    const option = document.createElement('option');
                    option.value = 'default';
                    option.textContent = '-- N/A --';
                    categoriaTplSelect.appendChild(option);
                    if (templateCategoryContainer) templateCategoryContainer.style.display = 'none'; // Hide if only default category
                }
                loadTemplate(); // Reload template after category change
            }

            function updateTemplateTags(cardType) {
                const tagContainer = $('tagContainer');
                if (!tagContainer) return;

                tagContainer.innerHTML = '';
                const tags = TPL_TAG_MAP[cardType] || [];
                tags.forEach(item => {
                    const button = document.createElement('button');
                    button.classList.add('tag-btn');
                    button.textContent = item.text;
                    button.setAttribute('data-tag', item.tag);
                    button.addEventListener('click', () => {
                        const plantillaTextArea = $('plantilla');
                        if (plantillaTextArea) {
                            const start = plantillaTextArea.selectionStart;
                            const end = plantillaTextArea.selectionEnd;
                            const text = plantillaTextArea.value;
                            plantillaTextArea.value = text.substring(0, start) + item.tag + text.substring(end, text.length);
                            plantillaTextArea.focus();
                            plantillaTextArea.selectionStart = plantillaTextArea.selectionEnd = start + item.tag.length;
                        }
                    });
                    tagContainer.appendChild(button);
                });
            }

            /* ---------- ENVÍO DE AVISOS INDIVIDUALES ---------- */
            function sendNotification(cardType, id, canal) {
                const db = getDatabase(cardType);
                const rec = db.find(r => r.id === id);
                if (!rec) {
                    showToast('Registro no encontrado.');
                    return;
                }

                // Determine the category for the template based on cardType
                let categoryForTemplate = 'default';
                if (cardType === 'tacografo' && rec.categoria) {
                    categoryForTemplate = rec.categoria;
                } else if (cardType === 'licencia') {
                    categoryForTemplate = 'LICENCIA COMUNITARIA';
                } else if (cardType === 'visado' && rec.tipo) {
                    categoryForTemplate = rec.tipo;
                }


                const tplBody = localStorage.getItem(`${canal === 'email' ? TPL_EMAIL_BODY_PREFIX : TPL_WHATSAPP_PREFIX}${cardType}_${categoryForTemplate}`) || '';
                const tplSubject = localStorage.getItem(`${TPL_EMAIL_SUBJECT_PREFIX}${cardType}_${categoryForTemplate}`) || '';

                if (!tplBody) {
                    showToast(`No hay plantilla configurada para ${cardType} (${categoryForTemplate}) en el canal ${canal}.`);
                    return;
                }

                if (canal === 'email') {
                    if (!rec.mail) {
                        showToast(`No hay correo electrónico para ${rec.nombre}.`);
                        return;
                    }
                    const body = fillTemplate(tplBody, rec, cardType);
                    const subject = fillTemplate(tplSubject, rec, cardType);
                    window.open(`mailto:${rec.mail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
                    showToast(`Email enviado a ${rec.nombre}.`);
                } else if (canal === 'whatsapp') {
                    if (!rec.telefono && !rec.tel) { // Check both 'telefono' and 'tel' for number
                        showToast(`No hay número de teléfono para ${rec.nombre}.`);
                        return;
                    }
                    const phone = (rec.telefono || rec.tel).replace(/\D/g, '');
                    const msg = fillTemplate(tplBody, rec, cardType);
                    const url = msg ? `https://wa.me/${phone}?text=${encodeURIComponent(msg)}` : `https://wa.me/${phone}`;
                    window.open(url, '_blank');
                    showToast(`WhatsApp enviado a ${rec.nombre}.`);
                }
            }


            /* ---------- ENVÍO DE AVISOS MASIVOS (Genérico) ---------- */
            function addMassiveAvisosListener(buttonId, categorySelectId, canalSelectId, daysInputId, cardType, monthSelectId = null, tipoSelectId = null) {
                const sendButton = $(buttonId);
                if (!sendButton) return;

                sendButton.addEventListener('click', () => {
                    const canal = $(canalSelectId)?.value; // Optional chaining for robustness
                    const daysBeforeInput = $(daysInputId);
                    const daysBefore = daysBeforeInput ? parseInt(daysBeforeInput.value, 10) : 0;
                    let categoryFilter = null;
                    if (categorySelectId) {
                        const catSelect = $(categorySelectId);
                        if (catSelect) categoryFilter = catSelect.value;
                    }

                    let monthFilter = null;
                    if (monthSelectId) {
                        const monthSelect = $(monthSelectId);
                        if (monthSelect) monthFilter = monthSelect.value;
                    }

                    let tipoFilter = null;
                    if (tipoSelectId) {
                        const tipoSelect = $(tipoSelectId);
                        if (tipoSelect) tipoFilter = tipoSelect.value;
                    }


                    let db = getDatabase(cardType);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const recipients = db.filter(rec => {
                        let expiryDate;
                        let recCategory; // For tacografo and visado
                        let recMonth; // For visado

                        if (cardType === 'tacografo' || cardType === 'licencia') {
                            if (!rec.fechaCaducidad) return false;
                            const [year, month, day] = rec.fechaCaducidad.split('-').map(Number);
                            expiryDate = new Date(year, month - 1, day);
                            recCategory = rec.categoria || 'LICENCIA COMUNITARIA'; // For licenses
                        } else if (cardType === 'visado') {
                            if (!rec.mes) return false;
                            // For visados, we assume renewals are checked against the current year for the specified month
                            const currentYear = today.getFullYear();
                            const monthNumber = getMonthNumber(rec.mes);
                            expiryDate = new Date(currentYear, monthNumber - 1, 1); // Start of the month
                            recCategory = rec.tipo; // Use 'tipo' as category for visados
                            recMonth = rec.mes;
                        } else {
                            return false;
                        }

                        expiryDate.setHours(0, 0, 0, 0);
                        const diffTime = expiryDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        const matchesCategory = !categoryFilter || categoryFilter === '' || recCategory === categoryFilter;
                        const matchesMonth = !monthFilter || monthFilter === '' || recMonth === monthFilter;
                        const matchesTipo = !tipoFilter || tipoFilter === '' || recCategory === tipoFilter; // recCategory is rec.tipo for visado

                        return matchesCategory && matchesMonth && matchesTipo && diffDays >= 0 && diffDays <= daysBefore;
                    });

                    if (recipients.length === 0) {
                        showToast('No se encontraron registros que cumplan los criterios para enviar avisos.');
                        return;
                    }

                    let delay = 0;
                    recipients.forEach(rec => {
                        const templateBody = localStorage.getItem(`${canal === 'email' || canal === 'ambos' ? TPL_EMAIL_BODY_PREFIX : TPL_WHATSAPP_PREFIX}${cardType}_${cardType === 'tacografo' ? rec.categoria : (cardType === 'licencia' ? 'LICENCIA COMUNITARIA' : rec.tipo)}`) || '';
                        const templateSubject = localStorage.getItem(`${TPL_EMAIL_SUBJECT_PREFIX}${cardType}_${cardType === 'tacografo' ? rec.categoria : (cardType === 'licencia' ? 'LICENCIA COMUNITARIA' : rec.tipo)}`) || '';

                        // Email
                        if (canal === 'email' || canal === 'ambos') {
                            if (rec.mail) {
                                const body = fillTemplate(templateBody, rec, cardType);
                                const subject = fillTemplate(templateSubject, rec, cardType);
                                setTimeout(() => {
                                    window.open(`mailto:${rec.mail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
                                }, delay);
                                delay += 300; // evita bloqueo de pop-ups
                            } else {
                                console.warn(`Skipping email for ${rec.nombre}: no email address.`);
                            }
                        }
                        // WhatsApp
                        if (canal === 'whatsapp' || canal === 'ambos') {
                            if (rec.tel || rec.telefono) {
                                const phone = (rec.tel || rec.telefono).replace(/\D/g, '');
                                const msg = fillTemplate(templateBody, rec, cardType);
                                setTimeout(() => {
                                    const url = msg ? `https://wa.me/${phone}?text=${encodeURIComponent(msg)}` : `https://wa.me/${phone}`;
                                    window.open(url, '_blank');
                                }, delay);
                                delay += 300;
                            } else {
                                console.warn(`Skipping WhatsApp for ${rec.nombre}: no phone number.`);
                            }
                        }
                    });

                    showToast(`Avisos lanzados para ${recipients.length} registros.`);
                });
            }


            /* ---------- DASHBOARD ---------- */
            function updateDashboard() {
                const daysBeforeDashboardSelect = $('daysBeforeDashboard');
                const daysBeforeDashboard = daysBeforeDashboardSelect ? parseInt(daysBeforeDashboardSelect.value, 10) : 0;
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Update settings display
                const dashTacografoSetting = $('dashboard-days-setting-tacografo');
                if (dashTacografoSetting) dashTacografoSetting.textContent = daysBeforeDashboard === 0 ? 'todas las próximas' : `${daysBeforeDashboard} `;
                const dashLicenciaSetting = $('dashboard-days-setting-licencia');
                if (dashLicenciaSetting) dashLicenciaSetting.textContent = daysBeforeDashboard === 0 ? 'todas las próximas' : `${daysBeforeDashboard} `;
                const dashVisadoSetting = $('dashboard-days-setting-visado');
                if (dashVisadoSetting) dashVisadoSetting.textContent = daysBeforeDashboard === 0 ? 'todas las próximas' : `${daysBeforeDashboard} `;


                // Helper to filter and count expiring cards
                const getExpiringCounts = (db, type, days) => {
                    return db.filter(rec => {
                        let expiryDate;
                        if (type === 'tacografo' || type === 'licencia') {
                            if (!rec.fechaCaducidad) return false;
                            const [year, month, day] = rec.fechaCaducidad.split('-').map(Number);
                            expiryDate = new Date(year, month - 1, day);
                        } else if (type === 'visado') {
                            if (!rec.mes) return false;
                            const currentYear = today.getFullYear();
                            const monthNumber = getMonthNumber(rec.mes);
                            expiryDate = new Date(currentYear, monthNumber - 1, 1);
                        } else {
                            return false;
                        }

                        expiryDate.setHours(0, 0, 0, 0);
                        const diffTime = expiryDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        return diffDays >= 0 && (days === 0 || diffDays <= days);
                    });
                };

                // Tacografo Dashboard
                const expiringTacografo = getExpiringCounts(dbTacografo, 'tacografo', daysBeforeDashboard);
                if ($('totalExpiringTacografo')) $('totalExpiringTacografo').textContent = expiringTacografo.length;
                if ($('expiringConductoresTacografo')) $('expiringConductoresTacografo').textContent = expiringTacografo.filter(rec => rec.categoria === 'CONDUCTOR').length;
                if ($('expiringEmpresasTacografo')) $('expiringEmpresasTacografo').textContent = expiringTacografo.filter(rec => rec.categoria === 'EMPRESA').length;
                if ($('expiringCentrosTacografo')) $('expiringCentrosTacografo').textContent = expiringTacografo.filter(rec => rec.categoria === 'CENTRO DE ENSAYO').length;
                renderExpiringList('tacografo', expiringTacografo);

                // Licencia Dashboard
                const expiringLicencia = getExpiringCounts(dbLicencia, 'licencia', daysBeforeDashboard);
                if ($('totalExpiringLicencia')) $('totalExpiringLicencia').textContent = expiringLicencia.length;
                if ($('expiringLicencias')) $('expiringLicencias').textContent = expiringLicencia.filter(rec => rec.categoria === 'LICENCIA COMUNITARIA').length;
                renderExpiringList('licencia', expiringLicencia);

                // Visado Dashboard
                const expiringVisado = getExpiringCounts(dbVisado, 'visado', daysBeforeDashboard);
                if ($('totalExpiringVisado')) $('totalExpiringVisado').textContent = expiringVisado.length;
                if ($('expiringMDPVisado')) $('expiringMDPVisado').textContent = expiringVisado.filter(rec => rec.tipo === 'MDP').length;
                if ($('expiringMDLVisado')) $('expiringMDLVisado').textContent = expiringVisado.filter(rec => rec.tipo === 'MDL').length;
                if ($('expiringOTVisado')) $('expiringOTVisado').textContent = expiringVisado.filter(rec => rec.tipo === 'OT').length;
                if ($('expiringMPCVisado')) $('expiringMPCVisado').textContent = expiringVisado.filter(rec => rec.tipo === 'MPC').length;
                renderExpiringList('visado', expiringVisado);
            }

            function renderExpiringList(type, data) {
                const listElement = $(`expiringCardsList${capitalizeFirstLetter(type)}`);
                if (!listElement) return;

                listElement.innerHTML = ''; // Clear previous list

                if (data.length === 0) {
                    listElement.innerHTML = '<li>No hay caducidades próximas en este período.</li>';
                    return;
                }

                // Sort data by expiry date (earliest first)
                data.sort((a, b) => {
                    let dateA, dateB;
                    if (type === 'tacografo' || type === 'licencia') {
                        dateA = new Date(a.fechaCaducidad);
                        dateB = new Date(b.fechaCaducidad);
                    } else if (type === 'visado') {
                        const today = new Date();
                        dateA = new Date(today.getFullYear(), getMonthNumber(a.mes) - 1, 1);
                        dateB = new Date(today.getFullYear(), getMonthNumber(b.mes) - 1, 1);
                    }
                    return dateA - dateB;
                });


                data.slice(0, 10).forEach(rec => { // Show top 10
                    const listItem = document.createElement('li');
                    let expiryInfo = '';
                    let displayDate = '';

                    if (type === 'tacografo' || type === 'licencia') {
                        expiryInfo = `${rec.nombre} (${rec.dni || rec.cif || 'N/A'}) - ${rec.categoria || 'Licencia Comunitaria'}`;
                        displayDate = formatDate(rec.fechaCaducidad);
                    } else if (type === 'visado') {
                        expiryInfo = `${rec.nombre} (${rec.dni || 'N/A'}) - ${rec.tipo}`;
                        displayDate = MONTH_NAMES[rec.mes] || rec.mes; // Display month name
                    }

                    listItem.innerHTML = `
                        <span class="expiring-info">${expiryInfo}</span>
                        <span class="expiring-date">Expira: ${displayDate}</span>
                        <div class="actions-inline">
                            <button onclick="sendNotification('${type}', '${rec.id}', 'email')">✉️</button>
                            <button onclick="sendNotification('${type}', '${rec.id}', 'whatsapp')">💬</button>
                        </div>
                    `;
                    listElement.appendChild(listItem);
                });

                if (data.length > 10) {
                    const moreItem = document.createElement('li');
                    moreItem.textContent = `... y ${data.length - 10} más.`;
                    listElement.appendChild(moreItem);
                }
            }


            /* ---------- ARRANQUE ---------- */
            document.addEventListener('DOMContentLoaded', () => {
                // Initialize section visibility
                showSection('dashboard-section');
                setActiveLink('nav-dashboard');

                // Setup forms
                setupForm('formTacografo', 'tacografo', ['nombre', 'dni', 'fechaCaducidad', 'categoria', 'mediador', 'telefono', 'email']);
                setupForm('formLicencia', 'licencia', ['nombre', 'cif', 'fechaCaducidad', 'telefono', 'email']);
                setupForm('formVisado', 'visado', ['nombre', 'dni', 'tel', 'mail', 'mes', 'tipo'], true); // Pass true for isVisadoForm

                // Setup table drawing and pagination
                drawTable('tacografo');
                setupTableSorting('tacografo');
                setupPagination('tacografo');
                setupCsvImportExport('tacografo', ['nombre', 'dni', 'fechaCaducidad', 'categoria', 'mediador', 'telefono', 'email']);

                drawTable('licencia');
                setupTableSorting('licencia');
                setupPagination('licencia');
                setupCsvImportExport('licencia', ['nombre', 'cif', 'fechaCaducidad', 'telefono', 'email']);

                drawTable('visado'); // Draw visado table
                setupTableSorting('visado'); // Setup sorting for visado
                setupPagination('visado'); // Setup pagination for visado
                setupCsvImportExport('visado', ['nombre', 'dni', 'tel', 'mail', 'mes', 'tipo']); // Setup CSV for visado


                // Setup massive avisos listeners
                addMassiveAvisosListener('enviarAvisosTacografo', 'categoriaAvisoTacografo', 'canalAvisoTacografo', 'daysBeforeMassiveTacografo', 'tacografo');
                addMassiveAvisosListener('enviarAvisosLicencia', null, 'canalAvisoLicencia', 'daysBeforeMassiveLicencia', 'licencia'); // No category select for licenses
                addMassiveAvisosListener('enviarAvisosVisado', 'tipoAvisoVisado', 'canalAvisoVisado', 'daysBeforeMassiveVisado', 'visado', 'mesAvisoVisado', 'tipoAvisoVisado'); // For visados

                // Plantillas section listeners
                if ($('templateCardType')) $('templateCardType').addEventListener('change', updateTemplateCategories);
                if ($('categoriaTpl')) $('categoriaTpl').addEventListener('change', loadTemplate);
                if ($('canalTpl')) $('canalTpl').addEventListener('change', loadTemplate);
                if ($('guardarTpl')) $('guardarTpl').addEventListener('click', saveTemplate);

                // Initial load for templates and dashboard
                updateTemplateCategories(); // This will also call loadTemplate
                updateDashboard();

                // Dashboard settings listener
                if ($('daysBeforeDashboard')) $('daysBeforeDashboard').addEventListener('change', updateDashboard);

                // Event listeners for custom modal buttons
                $('confirmYesBtn').addEventListener('click', () => {
                    hideCustomConfirm();
                    if (resolveCustomConfirm) resolveCustomConfirm(true);
                });

                $('confirmNoBtn').addEventListener('click', () => {
                    hideCustomConfirm();
                    if (resolveCustomConfirm) resolveCustomConfirm(false);
                });


                // Handle initial submenu state
                document.querySelectorAll('.sidebar nav ul li a').forEach(mainLink => {
                    if (mainLink.nextElementSibling && mainLink.nextElementSibling.classList.contains('submenu')) {
                        mainLink.addEventListener('click', function(e) {
                            e.preventDefault(); // Prevent navigating
                            this.nextElementSibling.classList.toggle('active');
                            this.classList.toggle('active'); // Also toggle active class on main link
                        });
                    }
                });

                 // Click handlers for dashboard cards to navigate to list view with filters
                 document.querySelectorAll('.dashboard-card p').forEach(card => {
                    card.addEventListener('click', function() {
                        const cardType = this.dataset.cardType;
                        const filterCategory = this.dataset.filterCategory;
                        const filterDays = this.dataset.filterDays; // "dynamic" or specific days

                        // Set appropriate filters
                        if (cardType === 'tacografo') {
                            const fCategoriaTacografo = $('fCategoriaTacografo');
                            if (fCategoriaTacografo) fCategoriaTacografo.value = filterCategory;
                            const buscarTacografo = $('buscarTacografo');
                            if (buscarTacografo) buscarTacografo.value = ''; // Clear search
                            currentPage.tacografo = 1;
                            drawTable('tacografo');
                            showSection('listado-tacografo-section');
                            setActiveLink('nav-listado-tacografo');
                            if ($('submenu-tacografo')) $('submenu-tacografo').classList.add('active'); // Expand submenu
                            if ($('nav-tacografo')) $('nav-tacografo').classList.add('active'); // Keep parent active
                        } else if (cardType === 'licencia') {
                            const buscarLicencia = $('buscarLicencia');
                            if (buscarLicencia) buscarLicencia.value = ''; // Clear search
                            currentPage.licencia = 1;
                            drawTable('licencia');
                            showSection('listado-licencia-section');
                            setActiveLink('nav-listado-licencia');
                            if ($('submenu-licencia')) $('submenu-licencia').classList.add('active'); // Expand submenu
                            if ($('nav-licencia')) $('nav-licencia').classList.add('active'); // Keep parent active
                        } else if (cardType === 'visado') {
                            const fMesVisado = $('fMesVisado');
                            if (fMesVisado) fMesVisado.value = ''; // Clear month filter
                            const fTipoVisado = $('fTipoVisado');
                            if (fTipoVisado) fTipoVisado.value = filterCategory; // Set type filter
                            const buscarVisado = $('buscarVisado');
                            if (buscarVisado) buscarVisado.value = ''; // Clear search
                            currentPage.visado = 1;
                            drawTable('visado');
                            showSection('listado-visado-section');
                            setActiveLink('nav-listado-visado');
                            if ($('submenu-visados')) $('submenu-visados').classList.add('active'); // Expand submenu
                            if ($('nav-visados')) $('nav-visados').classList.add('active'); // Keep parent active
                        }
                    });
                });
            });

        })();
    </script>
</body>

</html>
